name: PipelineX Self-Analysis

on:
  pull_request:
    paths:
      - '.github/workflows/**'
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  analyze:
    name: Analyze CI Pipeline
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2

      - name: Build PipelineX
        run: cargo build --release

      - name: Analyze CI Pipeline
        run: |
          ./target/release/pipelinex analyze .github/workflows/ci.yml --format json > analysis.json
          ./target/release/pipelinex analyze .github/workflows/ci.yml --format sarif > pipelinex.sarif
          ./target/release/pipelinex analyze .github/workflows/ci.yml > analysis.txt

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: pipelinex.sarif
          category: pipelinex

      - name: Generate Optimization Report
        run: |
          ./target/release/pipelinex diff .github/workflows/ci.yml > diff.txt || true
          ./target/release/pipelinex cost .github/workflows/ --format json > cost.json || true

      - name: Upload Reports as Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pipelinex-reports
          path: |
            analysis.json
            analysis.txt
            diff.txt
            cost.json
            pipelinex.sarif

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const analysis = fs.readFileSync('analysis.txt', 'utf8');
            const diff = fs.existsSync('diff.txt') ? fs.readFileSync('diff.txt', 'utf8') : 'No optimizations suggested';

            const body = `## üöÄ PipelineX Self-Analysis

            ### Current Pipeline Analysis
            \`\`\`
            ${analysis}
            \`\`\`

            ### Suggested Optimizations
            \`\`\`
            ${diff}
            \`\`\`

            ---
            üí° **Note:** This analysis was generated by PipelineX analyzing its own CI pipeline!
            üìä Full reports available in workflow artifacts.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Check for Critical Issues
        run: |
          CRITICAL_COUNT=$(jq '[.findings[] | select(.severity == "Critical")] | length' analysis.json)
          echo "Found $CRITICAL_COUNT critical issues"

          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "‚ö†Ô∏è Critical pipeline issues detected!"
            jq '.findings[] | select(.severity == "Critical")' analysis.json
            exit 1
          fi
