stages:
  - lint
  - build
  - test
  - integration
  - deploy

variables:
  DOCKER_HOST: tcp://docker:2375
  GIT_DEPTH: "0"

.node_template:
  image: node:20-alpine
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
  before_script:
    - npm ci

lint:frontend:
  extends: .node_template
  stage: lint
  script:
    - cd frontend && npm run lint
  rules:
    - changes:
        - frontend/**/*

lint:backend:
  extends: .node_template
  stage: lint
  script:
    - cd backend && npm run lint
  rules:
    - changes:
        - backend/**/*

build:frontend:
  extends: .node_template
  stage: build
  needs: ["lint:frontend"]
  script:
    - cd frontend && npm run build
  artifacts:
    paths:
      - frontend/dist/

build:backend:
  extends: .node_template
  stage: build
  needs: ["lint:backend"]
  script:
    - cd backend && npm run build
  artifacts:
    paths:
      - backend/dist/

test:frontend:
  extends: .node_template
  stage: test
  needs: ["build:frontend"]
  script:
    - cd frontend && npm test
  parallel: 3

test:backend:
  extends: .node_template
  stage: test
  needs: ["build:backend"]
  script:
    - cd backend && npm test
  parallel: 2

integration:
  stage: integration
  image: docker:24
  services:
    - docker:24-dind
  needs:
    - test:frontend
    - test:backend
  script:
    - docker compose -f docker-compose.test.yml up --abort-on-container-exit

deploy:staging:
  stage: deploy
  needs: ["integration"]
  script:
    - kubectl apply -f k8s/staging/
  environment:
    name: staging
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"

deploy:production:
  stage: deploy
  needs: ["integration"]
  script:
    - kubectl apply -f k8s/production/
  environment:
    name: production
  rules:
    - if: $CI_COMMIT_TAG
  when: manual
